"use strict";const unplugin=require("unplugin"),bundlerPluginCore=require("@codecov/bundler-plugin-core"),A=require("node:path"),c=require("webpack");function _interopDefaultCompat(e){return e&&typeof e=="object"&&"default"in e?e.default:e}function _interopNamespaceCompat(e){if(e&&typeof e=="object"&&"default"in e)return e;const a=Object.create(null);if(e)for(const n in e)a[n]=e[n];return a.default=e,a}const A__default=_interopDefaultCompat(A),c__namespace=_interopNamespaceCompat(c),r=/(\w|\[|]|\/)/g,findFilenameFormat=({assetName:e,filename:a,assetModuleFilename:n,chunkFilename:l,cssFilename:t,cssChunkFilename:u})=>{const m=e.replaceAll(r,"");return a!==""&&m.includes(a.replaceAll(r,""))?a:l!==""&&m.includes(l.replaceAll(r,""))?l:t!==""&&m.includes(t.replaceAll(r,""))?t:u!==""&&m.includes(u.replaceAll(r,""))?u:n!==""&&m.includes(n.replaceAll(r,""))?n:""},o="@codecov/webpack-plugin",b="0.0.1-beta.12",webpackBundleAnalysisPlugin=({output:e})=>({version:e.version,name:o,pluginVersion:b,buildStart:()=>{e.start(),e.setPlugin(o,b)},buildEnd:()=>{e.end()},writeBundle:async()=>{await e.write()},webpack(a){a.hooks.thisCompilation.tap(o,n=>{n.hooks.processAssets.tapPromise({name:o,stage:c__namespace.Compilation.PROCESS_ASSETS_STAGE_REPORT},async()=>{if(!e.bundleName||e.bundleName===""){bundlerPluginCore.red("Bundle name is not present or empty. Skipping upload.");return}if(e.setBundleName(e.bundleName),typeof n.outputOptions.chunkFormat=="string"){n.name&&n.name!==""&&e.setBundleName(`${e.bundleName}-${n.name}`);let s=n.outputOptions.chunkFormat;s==="commonjs"?s="cjs":s==="module"&&(s="esm"),e.setBundleName(`${e.bundleName}-${s}`)}const l=n.getStats().toJson({assets:!0,chunks:!0,modules:!0,builtAt:!0,hash:!0});e.bundler={name:"webpack",version:c__namespace.version};const t=n.outputOptions,{assets:u,chunks:m,modules:k}=l,F=[];if(u){const s=typeof t.filename=="string"?t.filename:"",i=typeof t.assetModuleFilename=="string"?t.assetModuleFilename:"",p=typeof t.chunkFilename=="string"?t.chunkFilename:"",f=typeof t.cssFilename=="string"?t.cssFilename:"",h=typeof t.chunkFilename=="string"?t.chunkFilename:"";await Promise.all(u.map(async d=>{const N=findFilenameFormat({assetName:d.name,filename:s,assetModuleFilename:i,chunkFilename:p,cssFilename:f,cssChunkFilename:h});if(A__default.extname(d.name)===".map")return;const w=n.getAsset(d.name);let S=null;w&&(S=await bundlerPluginCore.getCompressedSize({fileName:d.name,code:w.source.source()})),F.push({name:d.name,size:d.size,gzipSize:S,normalized:bundlerPluginCore.normalizePath(d.name,N)})})),e.assets=F}const y=new Map;if(m){let s=0;e.chunks=m.map(i=>{const p=i.id??"",f=`${s}-${p}`;return y.set(p,f),s+=1,{id:i.id?.toString()??"",uniqueId:f,entry:i.entry,initial:i.initial,files:i.files??[],names:i.names??[]}})}if(k&&(e.modules=k.map(s=>{const i=s.chunks??[],p=[];return i.forEach(f=>{const h=y.get(f);h&&p.push(h)}),{name:s.name??"",size:s.size??0,chunkUniqueIds:p}})),e.duration=Date.now()-(e.builtAt??0),e.outputPath=t.path??"",e.dryRun){const{RawSource:s}=c__namespace.sources;n.emitAsset(`${e.bundleName}-stats.json`,new s(e.bundleStatsToJson()))}})})}}),g=unplugin.createWebpackPlugin((e,a)=>{if(bundlerPluginCore.checkNodeVersion(a))return[];const n=bundlerPluginCore.normalizeOptions(e);if(!n.success){const{shouldExit:u}=bundlerPluginCore.handleErrors(n);return u&&process.exit(1),[]}const l=[],t=new bundlerPluginCore.Output(n.options);return n.options.enableBundleAnalysis&&l.push(webpackBundleAnalysisPlugin({output:t})),l}),codecovWebpackPlugin=g,_internal_webpackBundleAnalysisPlugin=webpackBundleAnalysisPlugin;exports._internal_webpackBundleAnalysisPlugin=_internal_webpackBundleAnalysisPlugin,exports.codecovWebpackPlugin=codecovWebpackPlugin;
//# sourceMappingURL=index.cjs.map
