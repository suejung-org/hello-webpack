"use strict";const semver=require("semver"),r$4=require("chalk"),node_util=require("node:util"),node_zlib=require("node:zlib"),zod=require("zod"),o$5=require("child_process"),web=require("node:stream/web");function _interopDefaultCompat($){return $&&typeof $=="object"&&"default"in $?$.default:$}const r__default=_interopDefaultCompat(r$4),o__default=_interopDefaultCompat(o$5);function prepareMessage($){return typeof $=="string"?$:$ instanceof Error?`${$.stack??""}`:JSON.stringify($,null,"	")}function l$o($){console.log(`[codecov] ${$}`)}function green($){return l$o(r__default.green(prepareMessage($)))}function red($){return l$o(r__default.red(prepareMessage($)))}function cyan($){return l$o(r__default.cyan(prepareMessage($)))}function debug($,{enabled:S=!0}={enabled:!0}){if(S)return l$o(r__default.italic.yellow(prepareMessage($)))}const e$2=">=18.18.0";function checkNodeVersion($){return semver.satisfies(process.version,e$2)?!1:(red(`Codecov ${$.framework} bundler plugin requires Node.js ${e$2}. You are using Node.js ${process.version}. Please upgrade your Node.js version.`),!0)}const o$4=/\.(?:css|html|json|js|svg|txt|xml|xhtml)$/,getCompressedSize=async({fileName:$,code:S})=>o$4.test($)?(await node_util.promisify(node_zlib.gzip)(typeof S=="string"?S:Buffer.from(S))).length:null,r$3=/[a-f0-9]{8,}/i,x=["[hash]","[contenthash]","[fullhash]","[chunkhash]"],g$3=$=>$.replace(/[|\\{}()[\]^$+*?.]/g,"\\$&").replace(/-/g,"\\x2d"),normalizePath=($,S)=>{const N=[];for(const L of x){const D=S.indexOf(L);D!==-1&&N.push({hashString:L,hashIndex:D})}let T=$;for(const L of N){const D=S.at(L.hashIndex-1)??"",M=`(?<leadingDelimiter>${g$3(D)})`;let V=S.at(L.hashIndex+L.hashString.length)??"";V==="["&&(V=".");const H=`(?<endingDelimiter>${g$3(V)})`,G=`(${M}(?<hash>[0-9a-zA-Z/+=-]+)${H})`,w=new RegExp(G,"i");T=T.replace(w,"$<leadingDelimiter>*$<endingDelimiter>")}return T===$&&r$3.test(T)?T.replace(r$3,"*"):T},createRollupAsset=async({source:$,fileName:S,formatString:N})=>{const T=$ instanceof Buffer?$.byteLength:Buffer.from($).byteLength,L=await getCompressedSize({fileName:S,code:$});return{name:S,size:T,gzipSize:L,normalized:normalizePath(S,N)}},l$n=/^[\w\d_:/@\.{}\[\]$-]+$/,u$f=zod.z.object({branch:zod.z.string({invalid_type_error:"`branch` must be a string."}).optional(),build:zod.z.string({invalid_type_error:"`build` must be a string."}).optional(),compareSha:zod.z.string({invalid_type_error:"`compareSha` must be a string."}).optional(),pr:zod.z.string({invalid_type_error:"`pr` must be a string."}).optional(),sha:zod.z.string({invalid_type_error:"`sha` must be a string."}).optional(),slug:zod.z.string({invalid_type_error:"`slug` must be a string."}).optional()}),p$4=$=>zod.z.object({apiUrl:zod.z.string({invalid_type_error:"`apiUrl` must be a string."}).url({message:`apiUrl: \`${$?.apiUrl}\` is not a valid URL.`}).default("https://api.codecov.io"),bundleName:zod.z.string({invalid_type_error:"`bundleName` must be a string.",required_error:"`bundleName` is required for uploading bundle analysis information."}).regex(l$n,{message:`bundleName: \`${$?.bundleName}\` does not match format: \`/^[wd_:/@.{}[]$-]+$/\`.`}),dryRun:zod.z.boolean({invalid_type_error:"`dryRun` must be a boolean."}).default(!1),retryCount:zod.z.number({invalid_type_error:"`retryCount` must be a number."}).positive({message:"`retryCount` must be a positive number."}).int({message:"`retryCount` must be an integer."}).default(3),enableBundleAnalysis:zod.z.boolean({invalid_type_error:"`enableBundleAnalysis` must be a boolean."}).default(!1),uploadToken:zod.z.string({invalid_type_error:"`uploadToken` must be a string."}).optional(),uploadOverrides:u$f.optional(),debug:zod.z.boolean({invalid_type_error:"`debug` must be a boolean."}).default(!1)}),normalizeOptions=$=>{const S=p$4($).safeParse($);if(!S.success){const N=[],T=S.error.issues;for(const L of T)N.push(L.message);return{success:!1,errors:N}}return{options:S.data,success:!0}},handleErrors=$=>{let S=!1;for(const N of $.errors)N.includes("bundleName")&&(S=!0),red(N);return{shouldExit:S}};class FailedFetchError extends Error{constructor(S){super(S)}}class NoUploadTokenError extends Error{constructor(S){super(S)}}class UploadLimitReachedError extends Error{constructor(S){super(S)}}const SPAWN_PROCESS_BUFFER_SIZE=104857600,DEFAULT_RETRY_COUNT=3,DEFAULT_RETRY_DELAY=1e3,OWNER_SLUG_JOIN=":::",REPO_SLUG_JOIN="::::";class BadResponseError extends Error{constructor(S){super(S)}}const delay=$=>new Promise(S=>setTimeout(S,$)),fetchWithRetry=async({url:$,retryCount:S,requestData:N,name:T})=>{let L=new Response(null,{status:400});for(let D=0;D<S+1;D++)try{if(debug(`Attempting to fetch ${T}, attempt: ${D+1}`),await delay(DEFAULT_RETRY_DELAY*D),L=await fetch($,N),!L.ok)throw new BadResponseError("Response not ok");break}catch(M){if(debug(`${T} fetch attempt ${D+1} failed`),D+1===S){if(red(`${T} failed after ${D} attempts`),!(M instanceof BadResponseError))throw M;return L}}return L};class InvalidSlugError extends Error{constructor(S){super(S)}}const preProcessBody=$=>{for(const[S,N]of Object.entries($))S==="slug"&&typeof N=="string"&&($[S]=encodeSlug(N)),(!N||N==="")&&($[S]=null);return $},encodeSlug=$=>{const S=$.lastIndexOf("/")+1,N=$.substring(0,S).trimEnd(),T=$.substring(S,$.length);if(N===""||T==="")throw red("Invalid owner and/or repo"),new InvalidSlugError("Invalid owner and/or repo");return[N?.split("/").join(OWNER_SLUG_JOIN).slice(0,-3),T].join(REPO_SLUG_JOIN)},R$3=zod.z.object({url:zod.z.string()}),getPreSignedURL=async({apiURL:$,uploadToken:S,serviceParams:N,retryCount:T=DEFAULT_RETRY_COUNT})=>{if(!S)throw red("No upload token found"),new NoUploadTokenError("No upload token found");const L=`${$}/upload/bundle_analysis/v1`;let D;try{D=await fetchWithRetry({url:L,retryCount:T,name:"`get-pre-signed-url`",requestData:{method:"POST",headers:{"Content-Type":"application/json",Authorization:`token ${S}`},body:JSON.stringify(preProcessBody(N))}})}catch{throw red("Failed to fetch pre-signed URL"),new FailedFetchError("Failed to fetch pre-signed URL")}if(D.status===429)throw red("Upload limit reached"),new UploadLimitReachedError("Upload limit reached");if(!D.ok)throw red("Failed to get pre-signed URL, bad response"),new FailedFetchError("Failed to get pre-signed URL");let M;try{M=await D.json()}catch{throw red("Failed to parse pre-signed URL body"),new FailedFetchError("Failed to parse pre-signed URL body")}const V=R$3.safeParse(M);if(!V.success)throw red("Failed to validate pre-signed URL"),new FailedFetchError("Failed to validate pre-signed URL");return green("Successfully pre-signed URL fetched"),V.data.url};function detect$l($){return($?.CI==="true"||$?.CI==="True")&&($?.APPVEYOR==="true"||$?.APPVEYOR==="True")}function _$5($){const{args:S,envs:N}=$;return S?.build&&S.build!==""?S.build:N?.APPVEYOR_JOB_ID??null}function E$2($){const{envs:S}=$;return S?.APPVEYOR_URL&&S?.APPVEYOR_REPO_NAME&&S?.APPVEYOR_BUILD_ID&&S?.APPVEYOR_JOB_ID?`${S?.APPVEYOR_URL}/project/${S?.APPVEYOR_REPO_NAME}/builds/${S?.APPVEYOR_BUILD_ID}/job/${S?.APPVEYOR_JOB_ID}`:null}function u$e($){const{args:S,envs:N}=$;return S?.branch&&S.branch!==""?S.branch:N?.APPVEYOR_REPO_BRANCH??null}function o$3($){return $?.APPVEYOR_ACCOUNT_NAME&&$?.APPVEYOR_PROJECT_SLUG&&$?.APPVEYOR_BUILD_VERSION?`${$?.APPVEYOR_ACCOUNT_NAME}/${$?.APPVEYOR_PROJECT_SLUG}/${$?.APPVEYOR_BUILD_VERSION}`:null}function R$2($){const{args:S,envs:N}=$;return S?.pr&&S.pr!==""?S.pr:N?.APPVEYOR_PULL_REQUEST_NUMBER??null}function O$1(){return"appveyor"}function getServiceName$l(){return"Appveyor CI"}function A($,S){const{args:N,envs:T}=$;if(N?.sha&&N.sha!=="")return debug(`Using commit: ${N.sha}`,{enabled:S.debug}),N.sha;const L=T?.APPVEYOR_PULL_REQUEST_HEAD_COMMIT??T?.APPVEYOR_REPO_COMMIT;return debug(`Using commit: ${L??""}`,{enabled:S.debug}),L??null}function c$l($){const{args:S,envs:N}=$;return S?.slug&&S.slug!==""?S.slug:N?.APPVEYOR_REPO_NAME??null}async function getServiceParams$l($,S){return{branch:u$e($),build:_$5($),buildURL:E$2($),commit:A($,S),job:o$3($.envs),pr:R$2($),service:O$1(),slug:c$l($)}}function getEnvVarNames$l(){return["APPVEYOR","APPVEYOR_ACCOUNT_NAME","APPVEYOR_BUILD_ID","APPVEYOR_BUILD_VERSION","APPVEYOR_JOB_ID","APPVEYOR_PROJECT_SLUG","APPVEYOR_PULL_REQUEST_HEAD_COMMIT","APPVEYOR_PULL_REQUEST_NUMBER","APPVEYOR_REPO_BRANCH","APPVEYOR_REPO_COMMIT","APPVEYOR_REPO_NAME","APPVEYOR_URL","CI"]}const r$2={__proto__:null,detect:detect$l,getEnvVarNames:getEnvVarNames$l,getServiceName:getServiceName$l,getServiceParams:getServiceParams$l};function runExternalProgram($,S=[]){const N=o__default.spawnSync($,S,{maxBuffer:SPAWN_PROCESS_BUFFER_SIZE});if(N.error)throw new Error(`Error running external program: ${N.error}`);return N.stdout.toString().trim()}function parseSlug($){if(typeof $!="string")return"";if($.match(/^(ssh|https?):/)){const S=($.split("//")[1]?.replace(".git","")??"")?.split("/")??"";return S.length>2?`${S[1]}/${S[2]}`:""}if($.match("@"))return $.split(":")[1]?.replace(".git","")??"";throw new Error(`Unable to parse slug URL: ${$}`)}function parseSlugFromRemoteAddr($){let S=null;return $||($=runExternalProgram("git",["config","--get","remote.origin.url"])||""),$&&(S=parseSlug($)),S==="/"&&(S=null),S}function detect$k($){return!!$?.SYSTEM_TEAMFOUNDATIONSERVERURI}function a$j($){const{args:S,envs:N}=$;return S?.build&&S.build!==""?S.build:N?.BUILD_BUILDNUMBER??null}function l$m($){const{envs:S}=$;return S?.SYSTEM_TEAMPROJECT&&S?.BUILD_BUILDID?`${S?.SYSTEM_TEAMFOUNDATIONSERVERURI}${S?.SYSTEM_TEAMPROJECT}/_build/results?buildId=${S?.BUILD_BUILDID}`:null}function m$a($){const{args:S,envs:N}=$;return S?.branch&&S.branch!==""?S.branch:N?.BUILD_SOURCEBRANCH?N?.BUILD_SOURCEBRANCH.toString().replace("refs/heads/",""):null}function P$e($){return $?.BUILD_BUILDID??null}function u$d($){const{args:S,envs:N}=$;return S?.pr&&S.pr!==""?S.pr:N?.SYSTEM_PULLREQUEST_PULLREQUESTNUMBER??N?.SYSTEM_PULLREQUEST_PULLREQUESTID??null}function d$d(){return"azure_pipelines"}function getServiceName$k(){return"Azure Pipelines"}function v$j($,S){const{args:N,envs:T}=$;if(N?.sha&&N.sha!=="")return debug(`Using commit: ${N?.sha}`,{enabled:S.debug}),N.sha;let L=T?.BUILD_SOURCEVERSION??null;if(u$d($)){const D=/^[a-z0-9]{40} [a-z0-9]{40}$/,M=o__default.execFileSync("git",["show","--no-patch","--format=%P"]).toString().trimEnd();if(debug(`Merge commit message: ${M}`,{enabled:S.debug}),D.exec(M)){const V=M.split(" ");debug(`Split merge commit: ${V}`,{enabled:S.debug}),L=V?.[1]??""}}return debug(`Using commit: ${L}`,{enabled:S.debug}),L}function g$2($){const{args:S,envs:N}=$;return S?.slug&&S.slug!==""?S.slug:N?.BUILD_REPOSITORY_NAME??parseSlugFromRemoteAddr("")??null}async function getServiceParams$k($,S){return{branch:m$a($),build:a$j($),buildURL:l$m($),commit:v$j($,S),job:P$e($.envs),pr:u$d($),service:d$d(),slug:g$2($)}}function getEnvVarNames$k(){return["BUILD_BUILDID","BUILD_BUILDNUMBER","BUILD_SOURCEBRANCH","BUILD_SOURCEVERSION","SYSTEM_PULLREQUEST_PULLREQUESTID","SYSTEM_PULLREQUEST_PULLREQUESTNUMBER","SYSTEM_TEAMFOUNDATIONSERVERURI","SYSTEM_TEAMPROJECT"]}const o$2={__proto__:null,detect:detect$k,getEnvVarNames:getEnvVarNames$k,getServiceName:getServiceName$k,getServiceParams:getServiceParams$k},r$1=40,c$k=/^[0-9a-f]+$/;function validateSHA($,S=r$1){return zod.z.string().length(S).refine(N=>c$k.test(N)).safeParse($).success}function detect$j($){return!!$?.CI&&!!$?.BITBUCKET_BUILD_NUMBER}function s$i($){const{args:S,envs:N}=$;return S?.build&&S.build!==""?S.build:N?.BITBUCKET_BUILD_NUMBER??null}function c$j(){return null}function v$i($){const{args:S,envs:N}=$;return S?.branch&&S?.branch!==""?S?.branch:N?.BITBUCKET_BRANCH??null}function l$l($){return $?.BITBUCKET_BUILD_NUMBER??null}function d$c($){const{args:S,envs:N}=$;return S?.pr&&S.pr!==""?S.pr:N?.BITBUCKET_PR_ID??null}function P$d(){return"bitbucket"}function getServiceName$j(){return"Bitbucket"}function m$8($,S){const{args:N,envs:T}=$;if(N?.sha&&N.sha!=="")return debug(`Using commit: ${N.sha}`,{enabled:S.debug}),N.sha;let L=T.BITBUCKET_COMMIT??"";return L&&validateSHA(L,12)&&(L=runExternalProgram("git",["rev-parse",L])),debug(`Using commit: ${L??""}`,{enabled:S.debug}),L??null}function B$1($){const{args:S,envs:N}=$;return S?.slug&&S.slug!==""?S.slug:N?.BITBUCKET_REPO_FULL_NAME??null}async function getServiceParams$j($,S){return{branch:v$i($),build:s$i($),buildURL:c$j(),commit:m$8($,S),job:l$l($.envs),pr:d$c($),service:P$d(),slug:B$1($)}}function getEnvVarNames$j(){return["CI","BITBUCKET_BUILD_NUMBER"]}const m$9={__proto__:null,detect:detect$j,getEnvVarNames:getEnvVarNames$j,getServiceName:getServiceName$j,getServiceParams:getServiceParams$j};function detect$i($){return!!$?.CI&&!!$?.BITRISE_IO}function u$c($){const{args:S,envs:N}=$;return S?.build&&S.build!==""?S.build:N?.BITRISE_BUILD_NUMBER??null}function s$h($){const{envs:S}=$;return S?.BITRISE_BUILD_URL??null}function a$i($){const{args:S,envs:N}=$;return S?.branch&&S.branch!==""?S.branch:N?.BITRISE_GIT_BRANCH??null}function c$i(){return null}function I$4($){const{args:S,envs:N}=$;return S?.pr&&S.pr!==""?S.pr:N?.BITRISE_PULL_REQUEST??null}function l$k(){return"bitrise"}function getServiceName$i(){return"Bitrise CI"}function v$h($,S){const{args:N,envs:T}=$;return N?.sha&&N.sha!==""?(debug(`Using commit: ${N.sha}`,{enabled:S.debug}),N.sha):(debug(`Using commit: ${T?.GIT_CLONE_COMMIT_HASH??""}`,{enabled:S.debug}),T?.GIT_CLONE_COMMIT_HASH??null)}function d$b($){const{args:S}=$;return S?.slug&&S.slug!==""?S.slug:parseSlugFromRemoteAddr("")??null}async function getServiceParams$i($,S){return{branch:a$i($),build:u$c($),buildURL:s$h($),commit:v$h($,S),job:c$i(),pr:I$4($),service:l$k(),slug:d$b($)}}function getEnvVarNames$i(){return["BITRISE_BUILD_NUMBER","BITRISE_BUILD_URL","BITRISE_GIT_BRANCH","BITRISE_IO","BITRISE_PULL_REQUEST","CI","GIT_CLONE_COMMIT_HASH"]}const i={__proto__:null,detect:detect$i,getEnvVarNames:getEnvVarNames$i,getServiceName:getServiceName$i,getServiceParams:getServiceParams$i};function detect$h($){return!!$?.BUILDKITE}function u$b($){const{args:S,envs:N}=$;return S?.build&&S.build!==""?S.build:N?.BUILDKITE_BUILD_NUMBER??null}function I$3($){return $.envs?.BUILDKITE_BUILD_URL??null}function s$g($){const{args:S,envs:N}=$;return S?.branch&&S.branch!==""?S.branch:N?.BUILDKITE_BRANCH??null}function a$h($){return $?.BUILDKITE_JOB_ID??null}function v$g($){const{args:S}=$;return S?.pr??null}function _getService(){return"buildkite"}function getServiceName$h(){return"Buildkite"}function c$h($,S){const{args:N,envs:T}=$;return N?.sha&&N.sha!==""?(debug(`Using commit: ${N.sha}`,{enabled:S.debug}),N.sha):(debug(`Using commit: ${N?.sha??T?.BUILDKITE_COMMIT}`,{enabled:S.debug}),T?.BUILDKITE_COMMIT??null)}function l$j($){const{args:S,envs:N}=$;return setSlug(S?.slug,N?.BUILDKITE_ORGANIZATION_SLUG,N?.BUILDKITE_PIPELINE_SLUG)}async function getServiceParams$h($,S){return{branch:s$g($),build:u$b($),buildURL:I$3($),commit:c$h($,S),job:a$h($.envs),pr:v$g($),service:_getService(),slug:l$j($)}}function getEnvVarNames$h(){return["BUILDKITE","BUILDKITE_BRANCH","BUILDKITE_BUILD_NUMBER","BUILDKITE_BUILD_URL","BUILDKITE_COMMIT","BUILDKITE_JOB_ID","BUILDKITE_PROJECT_SLUG"]}const t={__proto__:null,_getService,detect:detect$h,getEnvVarNames:getEnvVarNames$h,getServiceName:getServiceName$h,getServiceParams:getServiceParams$h};function detect$g($){return!!$?.CI&&!!$?.CIRCLECI}function u$a($){const{args:S,envs:N}=$;return S?.build&&S.build!==""?S.build:N?.CIRCLE_BUILD_NUM??null}function s$e($){return $.envs?.CIRCLE_BUILD_URL??null}function c$g(){return"circleci"}function getServiceName$g(){return"CircleCI"}function a$g($){const{args:S,envs:N}=$;return S?.branch&&S.branch!==""?S.branch:N?.CIRCLE_BRANCH??null}function v$f($,S){const{args:N,envs:T}=$;return N?.sha&&N.sha!==""?(debug(`Using commit: ${N.sha}`,{enabled:S.debug}),N.sha):(debug(`Using commit: ${T?.CIRCLE_SHA1}`,{enabled:S.debug}),T?.CIRCLE_SHA1??null)}function l$i($){const{args:S,envs:N}=$,T=setSlug(S?.slug,N?.CIRCLE_PROJECT_USERNAME,N?.CIRCLE_PROJECT_REPONAME);return N?.CIRCLE_REPOSITORY_URL&&N?.CIRCLE_REPOSITORY_URL!==""?`${N?.CIRCLE_REPOSITORY_URL?.split(":")[1]?.split(".git")[0]}`:T}function P$c($){const{args:S,envs:N}=$;return S?.pr&&S.pr!==""?S.pr:N?.CIRCLE_PR_NUMBER??null}function C$1($){return $?.CIRCLE_NODE_INDEX??null}async function getServiceParams$g($,S){return{branch:a$g($),build:u$a($),buildURL:s$e($),commit:v$f($,S),job:C$1($.envs),pr:P$c($),service:c$g(),slug:l$i($)}}function getEnvVarNames$g(){return["CI","CIRCLECI"]}const s$f={__proto__:null,detect:detect$g,getEnvVarNames:getEnvVarNames$g,getServiceName:getServiceName$g,getServiceParams:getServiceParams$g};function detect$f($){return!!$?.CIRRUS_CI}function s$d($){const{args:S,envs:N}=$;return S?.build&&S.build!==""?S.build:N?.CIRRUS_BUILD_ID??null}function c$f(){return null}function a$f($){const{args:S,envs:N}=$;return S?.branch&&S.branch!==""?S.branch:N?.CIRRUS_BRANCH??null}function v$e($){return $?.CIRRUS_TASK_ID??null}function l$h($){const{args:S,envs:N}=$;return S?.pr&&S.pr!==""?S.pr:N?.CIRRUS_PR??null}function P$b(){return"cirrus-ci"}function getServiceName$f(){return"Cirrus CI"}function d$a($,S){const{args:N,envs:T}=$;if(N?.sha&&N.sha!=="")return debug(`Using commit: ${N.sha}`,{enabled:S.debug}),N.sha;const L=T?.CIRRUS_CHANGE_IN_REPO??null;return debug(`Using commit: ${L}`,{enabled:S.debug}),L}function m$7($){const{args:S,envs:N}=$;return setSlug(S?.slug,N?.CIRRUS_REPO_OWNER,N?.CIRRUS_REPO_NAME)}async function getServiceParams$f($,S){return{branch:a$f($),build:s$d($),buildURL:c$f(),commit:d$a($,S),job:v$e($.envs),pr:l$h($),service:P$b(),slug:m$7($)}}function getEnvVarNames$f(){return["CIRRUS_CI"]}const p$3={__proto__:null,detect:detect$f,getEnvVarNames:getEnvVarNames$f,getServiceName:getServiceName$f,getServiceParams:getServiceParams$f};function detect$e($){return!!$?.CF_PAGES}function o$1($){const{args:S}=$;return S?.build??null}function u$9(){return null}function a$e($){const{args:S,envs:N}=$;return S?.branch&&S.branch!==""?S.branch:N?.CF_PAGES_BRANCH??null}function c$e(){return null}function s$c($){const{args:S}=$;return S?.pr??null}function l$g(){return"cloudflare-pages"}function getServiceName$e(){return"Cloudflare Pages"}function P$a($,S){const{args:N,envs:T}=$;return N?.sha&&N.sha!==""?(debug(`Using commit: ${N.sha}`,{enabled:S.debug}),N.sha):(debug(`Using commit: ${T?.CF_PAGES_COMMIT_SHA??""}`,{enabled:S.debug}),T?.CF_PAGES_COMMIT_SHA??null)}function v$d($){const{args:S}=$;return S?.slug??null}async function getServiceParams$e($,S){return{branch:a$e($),build:o$1($),buildURL:u$9(),commit:P$a($,S),job:c$e(),pr:s$c($),service:l$g(),slug:v$d($)}}function getEnvVarNames$e(){return["CF_PAGES","CF_PAGES_COMMIT_SHA","CF_PAGES_BRANCH","CF_PAGES_URL"]}const e$1={__proto__:null,detect:detect$e,getEnvVarNames:getEnvVarNames$e,getServiceName:getServiceName$e,getServiceParams:getServiceParams$e};function detect$d($){return!!$?.CODEBUILD_CI}function u$8($){const{args:S,envs:N}=$;return S?.build&&S.build!==""?S.build:N?.CODEBUILD_BUILD_ID??null}function s$b(){return null}function a$c($){const{args:S,envs:N}=$;return S?.branch&&S.branch!==""?S.branch:N?.CODEBUILD_WEBHOOK_HEAD_REF?N?.CODEBUILD_WEBHOOK_HEAD_REF.replace(/^refs\/heads\//,""):null}function E$1($){return $?.CODEBUILD_BUILD_ID??null}function c$d($){const{args:S,envs:N}=$;return S?.pr&&S.pr!==""?S.pr:N?.CODEBUILD_SOURCE_VERSION&&N?.CODEBUILD_SOURCE_VERSION.startsWith("pr/")?N?.CODEBUILD_SOURCE_VERSION.replace(/^pr\//,""):null}function _$4(){return"codebuild"}function getServiceName$d(){return"AWS CodeBuild"}function l$f($,S){const{args:N,envs:T}=$;if(N?.sha&&N.sha!=="")return debug(`Using commit: ${N.sha}`,{enabled:S.debug}),N.sha;const L=T?.CODEBUILD_RESOLVED_SOURCE_VERSION??null;return debug(`Using commit: ${L}`,{enabled:S.debug}),L}function O($){const{args:S,envs:N}=$;return S?.slug&&S?.slug!==""?S?.slug:N?.CODEBUILD_SOURCE_REPO_URL?N?.CODEBUILD_SOURCE_REPO_URL.toString().replace(/^.*github.com\//,"").replace(/\.git$/,""):null}async function getServiceParams$d($,S){return{branch:a$c($),build:u$8($),buildURL:s$b(),commit:l$f($,S),job:E$1($.envs),pr:c$d($),service:_$4(),slug:O($)}}function getEnvVarNames$d(){return["CODEBUILD_BUILD_ID","CODEBUILD_CI","CODEBUILD_RESOLVED_SOURCE_VERSION","CODEBUILD_SOURCE_REPO_URL","CODEBUILD_SOURCE_VERSION","CODEBUILD_WEBHOOK_HEAD_REF"]}const a$d={__proto__:null,detect:detect$d,getEnvVarNames:getEnvVarNames$d,getServiceName:getServiceName$d,getServiceParams:getServiceParams$d};function detect$c($){return!!$?.DRONE}function u$7($){const{args:S,envs:N}=$;return S?.build&&S.build!==""?S.build:N?.DRONE_BUILD_NUMBER??null}function s$a($){const{envs:S}=$;return S?.DRONE_BUILD_LINK??S?.DRONE_BUILD_URL??S?.CI_BUILD_URL??null}function a$b($){const{args:S,envs:N}=$;return S?.branch&&S.branch!==""?S?.branch:N?.DRONE_BRANCH??null}function c$c(){return null}function v$c($){const{args:S,envs:N}=$;return S?.pr&&S.pr!==""?S?.pr:N?.DRONE_PULL_REQUEST??null}function l$e(){return"drone.io"}function getServiceName$c(){return"Drone"}function P$9($,S){const{args:N,envs:T}=$;if(N?.sha&&N.sha!=="")return debug(`Using commit: ${N.sha}`,{enabled:S.debug}),N.sha;const L=T?.DRONE_COMMIT_SHA??null;return debug(`Using commit: ${L}`,{enabled:S.debug}),L}function d$9($){const{args:S,envs:N}=$;return S?.slug&&S?.slug!==""?S?.slug:N?.DRONE_REPO??null}async function getServiceParams$c($,S){return{branch:a$b($),build:u$7($),buildURL:s$a($),commit:P$9($,S),job:c$c(),pr:v$c($),service:l$e(),slug:d$9($)}}function getEnvVarNames$c(){return["DRONE","DRONE_BRANCH","DRONE_BUILD_NUMBER","DRONE_BUILD_URL","DRONE_COMMIT_SHA","DRONE_PULL_REQUEST","DRONE_REPO"]}const f$3={__proto__:null,detect:detect$c,getEnvVarNames:getEnvVarNames$c,getServiceName:getServiceName$c,getServiceParams:getServiceParams$c},n$2=zod.z.union([zod.z.string(),zod.z.number(),zod.z.boolean(),zod.z.null()]),jsonSchema=zod.z.lazy(()=>zod.z.union([n$2,zod.z.array(jsonSchema),zod.z.record(jsonSchema)]));function detect$b($){return!!$?.GITHUB_ACTIONS}function m$6($){const{args:S,envs:N}=$;return S?.build&&S.build!==""?S.build:N?.GITHUB_RUN_ID??null}async function b($){const S=`https://api.github.com/repos/${u$6($)}/actions/runs/${m$6($)}/jobs`,N=await fetch(S,{headers:{"User-Agent":"Awesome-Octocat-App"}});if(N.status!==200)return null;const T=await N.json(),L=jsonSchema.parse(T),{envs:D}=$;if(L&&typeof L=="object"&&"jobs"in L&&Array.isArray(L?.jobs)){for(const M of L?.jobs)if(M&&typeof M=="object"&&"name"in M&&M?.name==D?.GITHUB_JOB&&"html_url"in M&&typeof M?.html_url=="string")return M?.html_url}return null}async function f$2($){const{envs:S}=$,N=await b($);return N!==null?N:`${S?.GITHUB_SERVER_URL}/${u$6($)}/actions/runs/${m$6($)}`}function P$8($){const{args:S,envs:N}=$;if(S?.branch&&S.branch!=="")return S.branch;const T=/refs\/heads\/(.*)/.exec(N?.GITHUB_REF??"");let L;return T&&(L=T[1]),N?.GITHUB_HEAD_REF&&N?.GITHUB_HEAD_REF!==""&&(L=N?.GITHUB_HEAD_REF),L??null}function U($){return $?.GITHUB_WORKFLOW??null}function l$c($){const{args:S,envs:N}=$;if(S?.pr&&S.pr!=="")return S.pr;let T;if(N?.GITHUB_HEAD_REF&&N?.GITHUB_HEAD_REF!==""){const L=/refs\/pull\/([0-9]+)\/merge/.exec(N?.GITHUB_REF??"");L&&(T=L[1])}return T??null}function _$3(){return"github-actions"}function getServiceName$b(){return"GitHub Actions"}function p$2($,S){const{args:N,envs:T}=$;if(N?.sha&&N.sha!=="")return debug(`Using commit: ${N.sha}`,{enabled:S.debug}),N.sha;const L=l$c($);let D=T?.GITHUB_SHA;if(L){const M=/^[a-z0-9]{40} [a-z0-9]{40}$/,V=runExternalProgram("git",["show","--no-patch","--format=%P"]);if(debug(`Merge commit message: ${V}`,{enabled:S.debug}),M.exec(V)){const H=V.split(" ");debug(`Split commit message: ${H}`,{enabled:S.debug}),D=H[1]}}return debug(`Using commit: ${D??null}`,{enabled:S.debug}),D??null}function h($,S){const{args:N}=$;if(N?.compareSha&&N.compareSha!=="")return debug(`Using commit: ${N.compareSha}`,{enabled:S.debug}),N.compareSha;let T=null;if(l$c($)){const L=/^[a-z0-9]{40} [a-z0-9]{40}$/,D=runExternalProgram("git",["show","--no-patch","--format=%P"]);if(debug(`Merge commit message: ${D}`,{enabled:S.debug}),L.exec(D)){const M=D.split(" ");debug(`Split commit message: ${M}`,{enabled:S.debug}),T=M?.[0]?M[0]:null}}return debug(`Using compareSha: ${T??null}`,{enabled:S.debug}),T??null}function u$6($){const{args:S,envs:N}=$;return S?.slug&&S.slug!==""?S.slug:N?.GITHUB_REPOSITORY??null}async function getServiceParams$b($,S){return{branch:P$8($),build:m$6($),buildURL:await f$2($),commit:p$2($,S),compareSha:h($,S),job:U($.envs),pr:l$c($),service:_$3(),slug:u$6($)}}function getEnvVarNames$b(){return["GITHUB_ACTION","GITHUB_HEAD_REF","GITHUB_REF","GITHUB_REPOSITORY","GITHUB_RUN_ID","GITHUB_SERVER_URL","GITHUB_SHA","GITHUB_WORKFLOW"]}const l$d={__proto__:null,detect:detect$b,getEnvVarNames:getEnvVarNames$b,getServiceName:getServiceName$b,getServiceParams:getServiceParams$b};function detect$a($){return!!$?.GITLAB_CI}function _$2($){const{args:S,envs:N}=$;return S?.build&&S.build!==""?S.build:N?.CI_BUILD_ID??N?.CI_JOB_ID??null}function s$9(){return null}function I$2($){const{args:S,envs:N}=$;return S?.branch&&S.branch!==""?S.branch:N?.CI_BUILD_REF_NAME??N?.CI_COMMIT_REF_NAME??null}function a$a(){return null}function c$b($){const{args:S}=$;return S?.pr??null}function l$b(){return"gitlab"}function getServiceName$a(){return"GitLab CI"}function v$b($,S){const{args:N,envs:T}=$;if(N?.sha&&N.sha!=="")return debug(`Using commit: ${N.sha}`,{enabled:S.debug}),N.sha;const L=T?.CI_MERGE_REQUEST_SOURCE_BRANCH_SHA??T?.CI_BUILD_REF??T?.CI_COMMIT_SHA??null;return debug(`Using commit: ${L}`,{enabled:S.debug}),L}function P$7($){const{args:S,envs:N}=$;if(S?.slug&&S?.slug!=="")return S?.slug;const T=N?.CI_BUILD_REPO??N?.CI_REPOSITORY_URL??"";return N?.CI_PROJECT_PATH??parseSlugFromRemoteAddr(T)??null}async function getServiceParams$a($,S){return{branch:I$2($),build:_$2($),buildURL:s$9(),commit:v$b($,S),job:a$a(),pr:c$b($),service:l$b(),slug:P$7($)}}function getEnvVarNames$a(){return["CI_BUILD_ID","CI_BUILD_REF","CI_BUILD_REF_NAME","CI_BUILD_REPO","CI_COMMIT_REF_NAME","CI_COMMIT_SHA","CI_JOB_ID","CI_MERGE_REQUEST_SOURCE_BRANCH_SHA","CI_PROJECT_PATH","CI_REPOSITORY_URL","GITLAB_CI"]}const C={__proto__:null,detect:detect$a,getEnvVarNames:getEnvVarNames$a,getServiceName:getServiceName$a,getServiceParams:getServiceParams$a};function detect$9($){return!!$?.CI&&!!$?.HEROKU_TEST_RUN_BRANCH}function a$9($){const{args:S,envs:N}=$;return S?.build&&S.build!==""?S.build:N?.HEROKU_TEST_RUN_ID??null}function s$8(){return null}function c$a($){const{args:S,envs:N}=$;return S?.branch&&S.branch!==""?S.branch:N?.HEROKU_TEST_RUN_BRANCH??null}function l$a(){return null}function v$a($){const{args:S}=$;return S?.pr??null}function d$7(){return"heroku"}function getServiceName$9(){return"Heroku CI"}function m$5($,S){const{args:N,envs:T}=$;if(N?.sha&&N.sha!=="")return debug(`Using commit: ${N.sha}`,{enabled:S.debug}),N?.sha;const L=T?.HEROKU_TEST_RUN_COMMIT_VERSION??null;return debug(`Using commit: ${L}`,{enabled:S.debug}),L}function P$6($){const{args:S}=$;return S?.slug&&S.slug!==""?S?.slug:parseSlugFromRemoteAddr("")}async function getServiceParams$9($,S){return{branch:c$a($),build:a$9($),buildURL:s$8(),commit:m$5($,S),job:l$a(),pr:v$a($),service:d$7(),slug:P$6($)}}function getEnvVarNames$9(){return["CI","HEROKU_TEST_RUN_BRANCH","HEROKU_TEST_RUN_COMMIT_VERSION","HEROKU_TEST_RUN_ID"]}const d$8={__proto__:null,detect:detect$9,getEnvVarNames:getEnvVarNames$9,getServiceName:getServiceName$9,getServiceParams:getServiceParams$9};function detect$8($){return!!$?.JENKINS_URL}function s$7($){const{args:S,envs:N}=$;return S?.build&&S.build!==""?S.build:N?.BUILD_NUMBER??null}function c$8($){const{envs:S}=$;return S?.BUILD_URL?S?.BUILD_URL:null}function a$8($){const{args:S,envs:N}=$;return S?.branch&&S.branch!==""?S.branch:N?.ghprbSourceBranch??N?.CHANGE_BRANCH??N?.GIT_BRANCH??N?.BRANCH_NAME??null}function l$9(){return null}function v$9($){const{args:S,envs:N}=$;return S?.pr&&S.pr!==""?S.pr:N?.ghprbPullId??N?.CHANGE_ID??null}function d$6(){return"jenkins"}function getServiceName$8(){return"Jenkins CI"}function m$4($,S){const{args:N,envs:T}=$;if(N?.sha&&N.sha!=="")return debug(`Using commit: ${N.sha}`,{enabled:S.debug}),N.sha;const L=T?.ghprbActualCommit??T?.GIT_COMMIT??null;return debug(`Using commit: ${L}`,{enabled:S.debug}),L}function g$1($){const{args:S}=$;return S?.slug&&S?.slug!==""?S?.slug:parseSlugFromRemoteAddr("")}async function getServiceParams$8($,S){return{branch:a$8($),build:s$7($),buildURL:c$8($),commit:m$4($,S),job:l$9(),pr:v$9($),service:d$6(),slug:g$1($)}}function getEnvVarNames$8(){return["BRANCH_NAME","BUILD_NUMBER","BUILD_URL","CHANGE_ID","GIT_BRANCH","GIT_COMMIT","JENKINS_URL","ghprbActualCommit","ghprbPullId","ghprbSourceBranch"]}const c$9={__proto__:null,detect:detect$8,getEnvVarNames:getEnvVarNames$8,getServiceName:getServiceName$8,getServiceParams:getServiceParams$8};function isProgramInstalled($){return!o__default?.spawnSync($)?.error}function detect$7(){return isProgramInstalled("git")}function g($){const{args:S}=$;return S?.build??null}function m$3(){return null}function l$8($){const{args:S,envs:N}=$,T=S?.branch??N?.GIT_BRANCH??N?.BRANCH_NAME??null;if(T!=="")return T;try{return runExternalProgram("git",["rev-parse","--abbrev-ref","HEAD"])}catch(L){throw new Error(`There was an error getting the branch name from git: ${L}`)}}function v$8(){return null}function P$5($){const{args:S}=$;return S?.pr??null}function d$5(){return""}function getServiceName$7(){return"Local"}function f$1($,S){const{args:N,envs:T}=$,L=N?.sha??T?.GIT_COMMIT??null;if(L!=="")return debug(`Using commit: ${L}`,{enabled:S.debug}),L;try{const D=runExternalProgram("git",["rev-parse","HEAD"]);return debug(`Using commit: ${D}`,{enabled:S.debug}),D}catch(D){throw new Error(`There was an error getting the commit SHA from git: ${D}`)}}function p$1($){const{args:S}=$;if(S?.slug&&S?.slug!=="")return S.slug;try{const N=runExternalProgram("git",["config","--get","remote.origin.url"]);return parseSlug(N)}catch(N){throw new Error(`There was an error getting the slug from git: ${N}`)}}async function getServiceParams$7($,S){return{branch:l$8($),build:g($),buildURL:m$3(),commit:f$1($,S),job:v$8(),pr:P$5($),service:d$5(),slug:p$1($)}}function getEnvVarNames$7(){return["BRANCH_NAME","CI","GIT_BRANCH","GIT_COMMIT"]}const u$5={__proto__:null,detect:detect$7,getEnvVarNames:getEnvVarNames$7,getServiceName:getServiceName$7,getServiceParams:getServiceParams$7};function detect$6($){return!!$?.NETLIFY}function u$4($){const{args:S,envs:N}=$;return S?.build&&S.build!==""?S.build:N?.BUILD_ID??null}function a$7(){return null}function s$6($){const{args:S,envs:N}=$;return S?.branch&&S.branch!==""?S?.branch:N?.BRANCH??null}function c$7(){return null}function l$7($){const{args:S}=$;return S?.pr??null}function v$7(){return"netlify"}function getServiceName$6(){return"Netlify"}function d$4($,S){const{args:N,envs:T}=$;if(N?.sha&&N.sha!=="")return debug(`Using commit: ${N.sha}`,{enabled:S.debug}),N.sha;const L=T?.COMMIT_REF??null;return debug(`Using commit: ${L}`,{enabled:S.debug}),L}function P$4($){const{args:S}=$;return S?.slug??null}async function getServiceParams$6($,S){return{branch:s$6($),build:u$4($),buildURL:a$7(),commit:d$4($,S),job:c$7(),pr:l$7($),service:v$7(),slug:P$4($)}}function getEnvVarNames$6(){return["NETLIFY","BUILD_ID","REPOSITORY_URL","BRANCH","HEAD","COMMIT_REF","CACHED_COMMIT_REF","PULL_REQUEST","REVIEW_ID"]}const n$1={__proto__:null,detect:detect$6,getEnvVarNames:getEnvVarNames$6,getServiceName:getServiceName$6,getServiceParams:getServiceParams$6};function detect$5($){return!!$?.RENDER}function u$3($){const{args:S}=$;return S?.build??null}function E(){return null}function s$5($){const{args:S,envs:N}=$;return S?.branch&&S.branch!==""?S.branch:N?.RENDER_GIT_BRANCH??null}function R$1(){return null}function a$6($){const{args:S}=$;return S?.pr??null}function c$6(){return"render"}function getServiceName$5(){return"Render"}function v$6($,S){const{args:N,envs:T}=$;if(N?.sha&&N.sha!=="")return debug(`Using commit: ${N.sha}`,{enabled:S.debug}),N.sha;const L=T?.RENDER_GIT_COMMIT??null;return debug(`Using commit: ${L}`,{enabled:S.debug}),L}function l$6($){const{args:S,envs:N}=$;return S?.slug&&S?.slug!==""?S?.slug:N?.RENDER_GIT_REPO_SLUG??null}async function getServiceParams$5($,S){return{branch:s$5($),build:u$3($),buildURL:E(),commit:v$6($,S),job:R$1(),pr:a$6($),service:c$6(),slug:l$6($)}}function getEnvVarNames$5(){return["RENDER","IS_PULL_REQUEST","RENDER_DISCOVERY_SERVICE","RENDER_EXTERNAL_HOSTNAME","RENDER_EXTERNAL_URL","RENDER_GIT_BRANCH","RENDER_GIT_COMMIT","RENDER_GIT_REPO_SLUG","RENDER_INSTANCE_ID","RENDER_SERVICE_ID","RENDER_SERVICE_NAME","RENDER_SERVICE_TYPE"]}const k={__proto__:null,detect:detect$5,getEnvVarNames:getEnvVarNames$5,getServiceName:getServiceName$5,getServiceParams:getServiceParams$5};function detect$4($){return!!$?.TEAMCITY_VERSION}function a$5(){return null}function s$4(){return"teamcity"}function getServiceName$4(){return"TeamCity"}function c$5($){const{args:S,envs:N}=$;return S?.branch&&S.branch!==""?S.branch:N?.BRANCH_NAME??null}function l$5($,S){const{args:N,envs:T}=$;if(N?.sha&&N.sha!=="")return debug(`Using commit: ${N.sha}`,{enabled:S.debug}),N.sha;const L=T?.BUILD_VCS_NUMBER??null;return debug(`Using commit: ${L}`,{enabled:S.debug}),L}function v$5($){const{args:S}=$;return S?.slug&&S.slug!==""?S.slug:parseSlugFromRemoteAddr("")??null}function d$3($){const{args:S,envs:N}=$;return S?.build&&S.build!==""?S.build:N?.BUILD_NUMBER??null}function m$2($){const{args:S}=$;return S?.pr??null}function P$3(){return null}async function getServiceParams$4($,S){return{branch:c$5($),build:d$3($),buildURL:a$5(),commit:l$5($,S),job:P$3(),pr:m$2($),service:s$4(),slug:v$5($)}}function getEnvVarNames$4(){return["TEAMCITY_VERSION"]}const I$1={__proto__:null,detect:detect$4,getEnvVarNames:getEnvVarNames$4,getServiceName:getServiceName$4,getServiceParams:getServiceParams$4};function detect$3($){return!!$?.CI&&!!$?.TRAVIS&&!$?.SHIPPABLE}function u$2($){const{args:S,envs:N}=$;return S?.build&&S.build!==""?S.build:N?.TRAVIS_JOB_NUMBER??null}function a$4(){return null}function s$3($){const{args:S,envs:N}=$;if(S?.branch&&S.branch!=="")return S.branch;let T=null;return N?.TRAVIS_BRANCH!==N?.TRAVIS_TAG&&(T=N?.TRAVIS_PULL_REQUEST_BRANCH??N?.TRAVIS_BRANCH??null),T}function c$4($){return $?.TRAVIS_JOB_ID??null}function l$4($){const{args:S,envs:N}=$;return S?.pr&&S.pr!==""?S.pr:N?.TRAVIS_PULL_REQUEST??null}function v$3(){return"travis"}function getServiceName$3(){return"Travis CI"}function P$2($,S){const{args:N,envs:T}=$;if(N?.sha&&N.sha!=="")return debug(`Using commit: ${N.sha}`,{enabled:S.debug}),N.sha;const L=T?.TRAVIS_PULL_REQUEST_SHA??T?.TRAVIS_COMMIT??null;return debug(`Using commit: ${L}`,{enabled:S.debug}),L}function d$2($){const{args:S,envs:N}=$;return S?.slug&&S.slug!==""?S.slug:N?.TRAVIS_REPO_SLUG??null}async function getServiceParams$3($,S){return{branch:s$3($),build:u$2($),buildURL:a$4(),commit:P$2($,S),job:c$4($.envs),pr:l$4($),service:v$3(),slug:d$2($)}}function getEnvVarNames$3(){return["TRAVIS"]}const v$4={__proto__:null,detect:detect$3,getEnvVarNames:getEnvVarNames$3,getServiceName:getServiceName$3,getServiceParams:getServiceParams$3};function detect$2($){return!!$?.VERCEL}function _$1($){const{args:S}=$;return S?.build??null}function u$1(){return null}function s$2($){const{args:S,envs:N}=$;return S?.branch&&S.branch!==""?S.branch:N?.VERCEL_GIT_COMMIT_REF??null}function c$3(){return null}function a$3($){const{args:S}=$;return S?.pr??null}function R(){return"vercel"}function getServiceName$2(){return"Vercel"}function l$3($,S){const{args:N,envs:T}=$;if(N?.sha&&N.sha!=="")return debug(`Using commit: ${N.sha}`,{enabled:S.debug}),N.sha;const L=T?.VERCEL_GIT_COMMIT_SHA??null;return debug(`Using commit: ${L}`,{enabled:S.debug}),L}function v$2($){const{args:S,envs:N}=$;if(S?.slug&&S.slug!=="")return S.slug;let T=null;const L=N?.VERCEL_GIT_REPO_OWNER??"",D=N?.VERCEL_GIT_REPO_SLUG??"";return L&&D&&(T=`${L}/${D}`),T}async function getServiceParams$2($,S){return{branch:s$2($),build:_$1($),buildURL:u$1(),commit:l$3($,S),job:c$3(),pr:a$3($),service:R(),slug:v$2($)}}function getEnvVarNames$2(){return["VERCEL","CI","VERCEL_ENV","VERCEL_URL","VERCEL_BRANCH_URL","VERCEL_REGION","VERCEL_AUTOMATION_BYPASS_SECRET","VERCEL_GIT_PROVIDER","VERCEL_GIT_REPO_SLUG","VERCEL_GIT_REPO_OWNER","VERCEL_GIT_REPO_ID","VERCEL_GIT_COMMIT_REF","VERCEL_GIT_COMMIT_SHA","VERCEL_GIT_COMMIT_MESSAGE","VERCEL_GIT_COMMIT_AUTHOR_NAME","VERCEL_GIT_PREVIOUS_SHA","VERCEL_GIT_PULL_REQUEST_ID"]}const y={__proto__:null,detect:detect$2,getEnvVarNames:getEnvVarNames$2,getServiceName:getServiceName$2,getServiceParams:getServiceParams$2};function detect$1($){return!!$?.WERCKER_MAIN_PIPELINE_STARTED}function s$1($){const{args:S,envs:N}=$;return S?.build&&S.build!==""?S.build:N?.WERCKER_MAIN_PIPELINE_STARTED??null}function c$2($){const{envs:S}=$;return S?.WERCKER_BUILD_URL??null}function a$2($){const{args:S,envs:N}=$;return S?.branch&&S.branch!==""?S.branch:N?.WERCKER_GIT_BRANCH??null}function v$1(){return null}function P$1($){const{args:S}=$;return S?.pr??null}function l$2(){return"wercker"}function getServiceName$1(){return"Wercker CI"}function d$1($,S){const{args:N,envs:T}=$;if(N?.sha&&N.sha!=="")return debug(`Using commit: ${N.sha}`,{enabled:S.debug}),N.sha;const L=T?.WERCKER_GIT_COMMIT??null;return debug(`Using commit: ${L}`,{enabled:S.debug}),L}function m$1($){const{args:S,envs:N}=$;return setSlug(S?.slug,N?.WERCKER_GIT_OWNER,N?.WERCKER_GIT_REPOSITORY)}async function getServiceParams$1($,S){return{branch:a$2($),build:s$1($),buildURL:c$2($),commit:d$1($,S),job:v$1(),pr:P$1($),service:l$2(),slug:m$1($)}}function getEnvVarNames$1(){return["WERCKER_MAIN_PIPELINE_STARTED"]}const B={__proto__:null,detect:detect$1,getEnvVarNames:getEnvVarNames$1,getServiceName:getServiceName$1,getServiceParams:getServiceParams$1};function detect($){return $?.CI==="woodpecker"}function u($){const{args:S,envs:N}=$;return S?.build&&S.build!==""?S.build:N?.CI_BUILD_NUMBER??null}function s($){const{envs:S}=$;return S?.CI_BUILD_LINK??null}function c$1($){const{args:S,envs:N}=$;return S?.branch&&S.branch!==""?S.branch:N?.CI_COMMIT_SOURCE_BRANCH??N?.CI_COMMIT_BRANCH??null}function v($){const{envs:S}=$;return S?.CI_JOB_NUMBER??null}function a$1($){const{args:S,envs:N}=$;return S?.pr&&S.pr!==""?S.pr:N?.CI_COMMIT_PULL_REQUEST??null}function I(){return"woodpecker"}function getServiceName(){return"Woodpecker CI"}function _($,S){const{args:N,envs:T}=$;if(N?.sha&&N.sha!=="")return debug(`Using commit: ${N.sha}`,{enabled:S.debug}),N.sha;const L=T?.CI_COMMIT_SHA??null;return debug(`Using commit: ${L}`,{enabled:S.debug}),L}function l$1($){const{args:S,envs:N}=$;return S?.slug&&S.slug!==""?S.slug:N?.CI_REPO??null}async function getServiceParams($,S){return{branch:c$1($),build:u($),buildURL:s($),commit:_($,S),pr:a$1($),job:v($),service:I(),slug:l$1($)}}function getEnvVarNames(){return["CI","CI_BUILD_NUMBER","CI_BUILD_LINK","CI_COMMIT_SOURCE_BRANCH","CI_COMMIT_BRANCH","CI_JOB_NUMBER","CI_COMMIT_PULL_REQUEST","CI_COMMIT_SHA","CI_COMMIT_TAG","CI_REPO"]}const P={__proto__:null,detect,getEnvVarNames,getServiceName,getServiceParams},providerList=[r$2,o$2,m$9,i,t,s$f,p$3,e$1,a$d,f$3,l$d,C,d$8,c$9,n$1,k,I$1,v$4,y,B,P,u$5];async function detectProvider($,S){cyan("Detecting CI provider");for(const N of providerList)if(N.detect($.envs))return cyan(`Detected CI provider: ${N.getServiceName()}`),await N.getServiceParams($,S);throw red("Could not detect CI provider"),new Error("Could not detect provider")}function setSlug($,S,N){return typeof $<"u"&&$!==""?$:typeof S<"u"&&typeof N<"u"&&S!==""&&N!==""?`${S}/${N}`:null}class FailedUploadError extends Error{constructor(S){super(S)}}async function uploadStats({message:$,bundleName:S,preSignedUrl:N,retryCount:T=DEFAULT_RETRY_COUNT}){const L=$[Symbol.iterator](),D=new web.ReadableStream({pull(V){const H=L.next();H.done?V.close():V.enqueue(H.value)}}).pipeThrough(new web.TextEncoderStream);let M;try{M=await fetchWithRetry({url:N,retryCount:T,name:"`upload-stats`",requestData:{method:"PUT",headers:{"Content-Type":"application/json"},duplex:"half",body:D}})}catch{throw red("Failed to upload stats, fetch failed"),new FailedFetchError("Failed to upload stats")}if(M.status===429)throw red("Upload limit reached"),new UploadLimitReachedError("Upload limit reached");if(!M.ok)throw red(`Failed to upload stats, bad response. Response ${M.status} - ${M.statusText}`),new FailedUploadError("Failed to upload stats");return green(`Successfully uploaded stats for bundle: ${S}`),!0}var m=Object.defineProperty,c=($,S,N)=>S in $?m($,S,{enumerable:!0,configurable:!0,writable:!0,value:N}):$[S]=N,e=($,S,N)=>(c($,typeof S!="symbol"?S+"":S,N),N),p=($,S,N)=>{if(!S.has($))throw TypeError("Cannot "+N)},r=($,S,N)=>(p($,S,"read from private field"),N?N.call($):S.get($)),o=($,S,N)=>{if(S.has($))throw TypeError("Cannot add the same private member more than once");S instanceof WeakSet?S.add($):S.set($,N)},d=($,S,N,T)=>(p($,S,"write to private field"),T?T.call($,N):S.set($,N),N),l,a,n;class f{constructor(S){e(this,"apiUrl"),e(this,"dryRun"),e(this,"retryCount"),e(this,"enableBundleAnalysis"),e(this,"uploadToken"),e(this,"debug"),e(this,"originalBundleName"),e(this,"branch"),e(this,"build"),e(this,"pr"),e(this,"sha"),e(this,"slug"),e(this,"version"),e(this,"bundler"),e(this,"outputPath"),e(this,"builtAt"),e(this,"duration"),e(this,"assets"),e(this,"chunks"),e(this,"modules"),o(this,l,void 0),o(this,a,void 0),o(this,n,{bundleName:!1,pluginDetails:!1}),this.version="2",this.apiUrl=S.apiUrl,this.dryRun=S.dryRun,this.retryCount=S.retryCount,this.enableBundleAnalysis=S.enableBundleAnalysis,this.uploadToken=S.uploadToken,this.debug=S.debug,this.originalBundleName=S.bundleName,S.uploadOverrides&&(this.branch=S.uploadOverrides.branch,this.build=S.uploadOverrides.build,this.pr=S.uploadOverrides.pr,this.sha=S.uploadOverrides.sha,this.slug=S.uploadOverrides.slug),d(this,l,S.bundleName)}start(){this.builtAt=Date.now()}end(){this.duration=Date.now()-(this.builtAt??0)}lockBundleName(){r(this,n).bundleName=!0}unlockBundleName(){r(this,n).bundleName=!1}setBundleName(S){return r(this,n).bundleName||d(this,l,S),r(this,l)}get bundleName(){return r(this,l)}setPlugin(S,N){return r(this,n).pluginDetails||d(this,a,{name:S,version:N}),r(this,a)}get plugin(){return r(this,a)}lockPluginDetails(){r(this,n).pluginDetails=!0}unlockPluginDetails(){r(this,n).pluginDetails=!1}async write(){if(this.dryRun||!this.bundleName||this.bundleName==="")return;const S={branch:this.branch,build:this.build,pr:this.pr,sha:this.sha,slug:this.slug},N={envs:process.env,args:S},T=await detectProvider(N,this);let L="";try{L=await getPreSignedURL({apiURL:this?.apiUrl??"https://api.codecov.io",uploadToken:this?.uploadToken,serviceParams:T,retryCount:this?.retryCount})}catch{return}try{await uploadStats({preSignedUrl:L,bundleName:this.bundleName,message:this.bundleStatsToJson(),retryCount:this?.retryCount})}catch{return}}bundleStatsToJson(){const S={version:this.version,builtAt:this.builtAt,duration:this.duration,bundleName:this.bundleName??"",outputPath:this.outputPath,bundler:this.bundler,plugin:this.plugin,assets:this.assets,chunks:this.chunks,modules:this.modules};return JSON.stringify(S)}}l=new WeakMap,a=new WeakMap,n=new WeakMap,exports.Output=f,exports.checkNodeVersion=checkNodeVersion,exports.createRollupAsset=createRollupAsset,exports.getCompressedSize=getCompressedSize,exports.handleErrors=handleErrors,exports.normalizeOptions=normalizeOptions,exports.normalizePath=normalizePath,exports.red=red;
//# sourceMappingURL=index.cjs.map
